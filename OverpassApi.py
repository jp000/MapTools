# coding=utf-8
from __future__ import print_function

import requests


urlFmt = r'http://overpass-api.de/api/interpreter?data=[out:xml][maxsize:500000000][timeout:300];{}out body;'

def GetUrl(url, fileName):
    r = requests.get(url, headers={'Referer': 'https://www.saia-pcd.com'}, stream=True)
    if r.status_code == 200:
        with open(fileName, 'wb') as out:
            for chunk in r.iter_content(1024):
                out.write(chunk)
        print('Created {}: {}'.format(fileName, url))
    else:
        print('Failed: {} {}: {}'.format(r.status_code, r.reason, url))

def GetArea(query, fileName, raw=False):
    if raw:
        url = urlFmt.format(query)
    else:
        url = urlFmt.format(query + r'->.X;(node(area.X);<;);')
    GetUrl(url, fileName)

def getBox(south, west, north, east, fileName):
    q = urlFmt.format('(node({},{},{},{});<;);'.format(south,west,north,east))
    GetUrl(q, fileName)

    
def someAreaTest():
    GetArea(r'area[name="Fribourg/Freiburg"][boundary=administrative][admin_level=4]', 'Fribourg.osm')
    GetArea(r'relation(1718788);node(around:300);<;->.X;', '3Rivieres.osm', True)
    GetArea(r'(node(329205815);node(around:5000);<;);', 'Alba.osm', True)

def areaUnionTest():
    GetArea(r'('
         r'area[name="Fribourg/Freiburg"][boundary=administrative][admin_level=4];'
         r'area[name~"^District .*Aigle$"][type=boundary][boundary=administrative][admin_level=6];'
         r')', 'Fribourg-plus.osm')


def polyIntersectionTest():
    poly = [46.70126,7.02301,46.70126,7.27776,46.87427,7.27776,46.87427,7.02301,46.70126,7.02301]
    poly1 = [46.83953,7.13768,46.81745,7.06284,46.78172,7.09373,46.75539,7.12051,46.75492,7.16789,46.77514,7.20634,46.82544,7.20360,46.83953,7.13768]

    q = '(' \
            'node(poly:"{}");' \
            '- node(poly:"{}");' \
        ');' \
        '(' \
            '._;' \
            '<;' \
        ');'.format(' '.join([str(x) for x in poly]), ' '.join([str(x) for x in poly1]))
    GetUrl(urlFmt.format(q), 'AA.osm')

def polySimpleTest():
    poly = '''
        node(poly:"43.37760 -1.77361 43.37711 -1.79283 43.33741 -1.76846 43.30994 -1.74374 43.30419 -1.66100 43.28295 -1.57345 43.28820 -1.52744 43.28745 -1.46736 43.26271 -1.45363 43.26171 -1.42445 43.24120 -1.39389 43.19466 -1.40625 43.16087 -1.36711 43.12454 -1.33827 43.12905 -1.30394 43.14759 -1.25587 43.13231 -1.23631 43.08042 -1.19373 43.02674 -1.09898 43.02573 -1.03924 43.03226 -0.98568 42.97778 -0.91118 42.96471 -0.88062 42.98506 -0.84423 42.96069 -0.77969 42.93833 -0.68802 42.87269 -0.54485 42.83972 -0.51773 42.83544 -0.46898 42.88804 -0.40169 42.91319 -0.31723 42.94059 -0.30590 42.93833 -0.20256 42.90640 -0.22007 42.87320 -0.21046 42.86112 -0.15072 42.79616 -0.15209 42.76970 -0.13390 42.72911 -0.07553 42.73012 -0.00927 42.80094 0.01717 42.85583 0.01408 42.85608 0.06180 42.88678 0.08137 42.87043 0.11845 42.84526 0.12291 42.81782 0.18059 42.81983 0.23380 42.81354 0.31826 42.78507 0.37766 42.74752 0.46829 42.72331 0.48580 42.75306 0.57472 42.79339 0.61455 42.83872 0.68459 42.86011 0.72029 42.85759 0.78861 42.81832 0.89092 42.81480 1.04679 42.84551 1.08284 42.83821 1.15528 42.78557 1.08936 42.76541 1.11477 42.77449 1.14326 42.77852 1.17794 42.78381 1.25862 42.75382 1.30909 42.75357 1.35201 42.76819 1.40247 42.71372 1.43200 42.69783 1.45123 42.71019 1.47217 42.69051 1.47972 42.68799 1.50787 42.73743 1.51508 42.75256 1.54839 42.75508 1.57551 42.70868 1.63044 42.70161 1.68365 42.69455 1.70700 42.66148 1.72966 42.64507 1.71867 42.63446 1.71936 42.62487 1.79180 42.64305 1.82991 42.62764 1.85394 42.59732 1.86356 42.59101 1.91059 42.57584 1.97514 42.53841 2.00741 42.48957 2.08225 42.48830 2.11281 42.45335 2.17255 42.45411 2.20928 42.44626 2.25529 42.45335 2.29889 42.49564 2.37579 42.48096 2.40566 42.49185 2.44240 42.51589 2.45785 42.50881 2.48497 42.47235 2.57046 42.43815 2.60925 42.42092 2.67826 42.40394 2.76890 42.41002 2.80632 42.44246 2.84237 42.44879 2.87773 42.44955 2.92065 42.46349 2.94468 42.46146 3.02708 42.42422 3.05420 42.42168 3.11291 42.42523 3.16715 42.43157 3.18192 42.44525 3.17230 42.44778 3.08372 42.48552 3.04733 42.48476 3.01472 42.48830 2.94365 42.47843 2.85885 42.44778 2.79739 42.44727 2.75036 42.43435 2.72427 42.51058 2.56462 42.52424 2.54059 42.54701 2.47158 42.54145 2.42832 42.51766 2.40807 42.52728 2.36927 42.47336 2.27486 42.48045 2.21649 42.52247 2.09427 42.56117 2.01668 42.59859 1.98887 42.62234 1.89377 42.66350 1.85360 42.66073 1.81686 42.65164 1.75644 42.69783 1.73790 42.72961 1.69430 42.72457 1.65962 42.76693 1.61533 42.77877 1.54701 42.75936 1.47629 42.79112 1.40247 42.79515 1.34411 42.78280 1.29913 42.80900 1.26411 42.80422 1.22120 42.79565 1.13503 42.83670 1.19717 42.84828 1.19888 42.86212 1.18069 42.86892 1.07117 42.83595 0.99667 42.83796 0.94276 42.83821 0.88577 42.87219 0.82294 42.89508 0.70312 42.84048 0.64304 42.84199 0.61523 42.77751 0.56408 42.75458 0.51464 42.77272 0.50434 42.77146 0.44666 42.79641 0.43396 42.84652 0.31551 42.84602 0.21080 42.84828 0.15724 42.87898 0.16033 42.90464 0.11673 42.91294 0.08823 42.87294 -0.02506 42.74827 -0.04326 42.78734 -0.11845 42.83418 -0.12463 42.86691 -0.09510 42.89684 -0.10815 42.89936 -0.12600 42.87798 -0.15999 42.89785 -0.19329 42.94637 -0.16033 42.95693 -0.19054 42.96823 -0.28805 42.96672 -0.33337 42.93079 -0.33749 42.91445 -0.42881 42.86061 -0.48443 42.89181 -0.50331 42.91319 -0.55859 42.93908 -0.62828 42.97577 -0.70690 43.00038 -0.80303 43.00640 -0.85350 42.98682 -0.88028 43.01243 -0.89024 43.05660 -0.96474 43.06412 -1.00456 43.06061 -1.03443 43.05334 -1.07254 43.04305 -1.09589 43.16713 -1.22154 43.16963 -1.24969 43.15811 -1.29742 43.14108 -1.31973 43.18941 -1.33312 43.19892 -1.37329 43.26871 -1.33999 43.27796 -1.42479 43.29895 -1.42994 43.31544 -1.47526 43.31469 -1.52985 43.29920 -1.54289 43.31569 -1.57516 43.33617 -1.65894 43.32068 -1.71593 43.34740 -1.73241 43.37760 -1.77361");
        ( ._; <;);
    '''
#    GetUrl(urlFmt.format(poly), 'GR10.osm')

    poly = '''
    node(poly: "43.15485 6.52348 43.15485 6.70303 43.28895 6.70303 43.28895 6.52348 43.15485 6.52348");
        ( ._; <;);
    '''
    GetUrl(urlFmt.format(poly), r'..\tmp\St Tropez.osm')

def poly_1():
    q = '(' \
            'node(poly:"43.29995 6.45996 43.23595 6.76311 43.30270 6.71471 43.36987 6.68930 43.36188 6.61034 43.33916 6.53687 43.29995 6.45996");' \
            '- node(poly:"43.30320 6.49910 43.25896 6.73084 43.30170 6.69651 43.34815 6.67694 43.34416 6.61446 43.32743 6.54716 43.30320 6.49910");' \
        ');' \
        '(' \
            '._;' \
            '<;' \
        ');'
    GetUrl(urlFmt.format(q), 'St_Tropez.osm')

def boundingSimpleTest():
    getBox(42.73,10.25,42.82,10.34, 'Elba1.osm')

def getAreaWithBoundingBox():
    b = '&bbox=114.41162,-8.87964,116.12823,-8.02388'

def areaIntersectionTest():
    q = '''
        (
            area[name="Fribourg/Freiburg"][boundary=administrative][admin_level=4];
            area[name~"^District .*Aigle$"][boundary=administrative][admin_level=6];
        )->.include;
        (
            area[name="Marly"][boundary=administrative][admin_level=8];
            area[name="Villars-sur-GlÃ¢ne"][boundary=administrative][admin_level=8];
        )->.exclude;
        (
            ( node(area.include); - node(area.exclude); ); (._;<;);
            ( way(area.include); - way(area.exclude); ); (._;<;);
            ( relation(area.include); - relation(area.exclude); ); (._;<<;);
        );
    '''
    #f = urlFmt.format(''.join(q.split()))
    f = urlFmt.format(q)
    GetUrl(f, 'AA1.osm')


def compareTest():
    f = urlFmt.format('(area[name="Fribourg/Freiburg"][boundary=administrative][admin_level=4];)->.X;(node(area.X);<;);')
    GetUrl(f, 'AA1.osm')
    f = urlFmt.format('(area[name="Fribourg/Freiburg"][boundary=administrative][admin_level=4];)->.X;(node(area.X);<;way(area.X);<;relation(area.X);<<;);')
    GetUrl(f, 'AA2.osm')

if __name__ == '__main__':
    polySimpleTest()

